name: Build Instube Final Fix
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Zip கையாளுதல்
      - name: Unzip Source Code
        run: |
          if [ -f "Instube-downloader.zip" ]; then
            unzip "Instube-downloader.zip"
            if [ -d "Instube-downloader" ]; then cp -r Instube-downloader/* .; fi
            if [ -d "Instube" ]; then cp -r Instube/* .; fi
          else
            echo "Zip missing, creating dummy..."
            mkdir -p app
          fi

      # 2. Java Setup (Gradle 8-க்கு Java 17 அவசியம்)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ========================================================
      # STEP 4: FORCE GRADLE 8.0 (இதுதான் மிக முக்கியம்)
      # ========================================================
      - name: Generate Compatible Gradle Wrapper
        run: |
          echo "include ':app'" > settings.gradle
          
          cat <<EOF > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.0.2'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF

          # இந்த வரியை மாற்றியுள்ளேன்: சரியான வெர்ஷனை கட்டாயப்படுத்துகிறது
          gradle wrapper --gradle-version 8.0

      # ========================================================
      # STEP 5: APP SETTINGS
      # ========================================================
      - name: Inject app/build.gradle
        run: |
          mkdir -p app
          cat <<EOF > app/build.gradle
          plugins {
              id 'com.android.application'
          }
          android {
              namespace 'com.example.instube'
              compileSdk 33
              defaultConfig {
                  applicationId "com.example.instube"
                  minSdk 24
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }
          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.9.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF

      # ========================================================
      # STEP 6: MANIFEST
      # ========================================================
      - name: Inject AndroidManifest.xml
        run: |
          mkdir -p app/src/main
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.example.instube">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
              <application
                  android:allowBackup="true"
                  android:label="Instube"
                  android:theme="@style/Theme.MaterialComponents.Light.NoActionBar"
                  android:requestLegacyExternalStorage="true" 
                  android:usesCleartextTraffic="true">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      # ========================================================
      # STEP 7: UI & JAVA LOGIC
      # ========================================================
      - name: Inject UI & Logic
        run: |
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/java/com/example/instube
          
          # LAYOUT
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:gravity="center"
              android:padding="20dp">
              <TextView android:text="Instube Video Downloader" android:textSize="24sp" android:layout_width="wrap_content" android:layout_height="wrap_content" android:textColor="#FF0000"/>
              <EditText android:id="@+id/urlInput" android:hint="Paste Link Here" android:layout_width="match_parent" android:layout_height="60dp" android:layout_marginTop="30dp"/>
              <Button android:id="@+id/downloadBtn" android:text="Download Video" android:layout_width="match_parent" android:layout_height="wrap_content" android:layout_marginTop="20dp"/>
              <TextView android:id="@+id/statusText" android:text="Ready" android:layout_width="match_parent" android:layout_height="wrap_content" android:layout_marginTop="20dp" android:gravity="center"/>
              <WebView android:id="@+id/webView" android:layout_width="1dp" android:layout_height="1dp" android:visibility="invisible"/>
          </LinearLayout>
          EOF

          # JAVA
          cat <<EOF > app/src/main/java/com/example/instube/MainActivity.java
          package com.example.instube;
          import android.app.Activity;
          import android.app.DownloadManager;
          import android.content.Context;
          import android.net.Uri;
          import android.os.Bundle;
          import android.os.Environment;
          import android.view.View;
          import android.webkit.JavascriptInterface;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import android.widget.Button;
          import android.widget.EditText;
          import android.widget.TextView;
          import android.widget.Toast;

          public class MainActivity extends Activity {
              EditText urlInput; Button downloadBtn; TextView statusText; WebView webView;
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  urlInput = findViewById(R.id.urlInput);
                  downloadBtn = findViewById(R.id.downloadBtn);
                  statusText = findViewById(R.id.statusText);
                  webView = findViewById(R.id.webView);
                  setupWebView();
                  downloadBtn.setOnClickListener(v -> {
                      String url = urlInput.getText().toString();
                      if(!url.isEmpty()) { 
                          statusText.setText("Checking Link..."); 
                          if(!url.startsWith("http")) url = "https://" + url;
                          webView.loadUrl(url); 
                      }
                  });
              }
              private void setupWebView() {
                  webView.getSettings().setJavaScriptEnabled(true);
                  webView.getSettings().setDomStorageEnabled(true);
                  webView.getSettings().setUserAgentString("Mozilla/5.0 (Linux; Android 13; Pixel 6)");
                  webView.addJavascriptInterface(new VideoInterface(), "InstubeBridge");
                  webView.setWebViewClient(new WebViewClient() {
                      @Override
                      public void onPageFinished(WebView view, String url) {
                          webView.loadUrl("javascript:(function(){ var v=document.querySelector('meta[property=\"og:video\"]'); if(v) InstubeBridge.found(v.content); else { var t=document.getElementsByTagName('video')[0]; if(t) InstubeBridge.found(t.src); } })()");
                      }
                  });
              }
              class VideoInterface {
                  @JavascriptInterface public void found(String u) {
                      runOnUiThread(() -> { statusText.setText("Downloading..."); 
                      try {
                          DownloadManager.Request r = new DownloadManager.Request(Uri.parse(u));
                          r.setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE_NOTIFY_COMPLETED);
                          r.setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, "Instube_"+System.currentTimeMillis()+".mp4");
                          ((DownloadManager)getSystemService(DOWNLOAD_SERVICE)).enqueue(r);
                          Toast.makeText(MainActivity.this, "Download Started!", Toast.LENGTH_LONG).show();
                      } catch(Exception e) { statusText.setText("Error: "+e.getMessage()); }
                      });
                  }
              }
          }
          EOF

      # ========================================================
      # STEP 8: BUILD APK
      # ========================================================
      - name: Build Debug APK
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Instube-APP
          path: app/build/outputs/apk/debug/app-debug.apk
          
